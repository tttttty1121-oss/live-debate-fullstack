# ğŸš€ ç›´æ’­è¾©è®ºç³»ç»Ÿ - ä¸­é—´å±‚ç½‘å…³æœåŠ¡

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯ç›´æ’­è¾©è®ºç³»ç»Ÿçš„ä¸­é—´å±‚ç½‘å…³æœåŠ¡ï¼Œä½¿ç”¨ **Node.js + Express** å®ç°ï¼Œæ›¿ä»£äº†ä¹‹å‰çš„ Nginx åå‘ä»£ç†æ–¹æ¡ˆã€‚

### ğŸ—ï¸ æ¶æ„è¯´æ˜

```
å®¢æˆ·ç«¯ (å°ç¨‹åº/åå°ç®¡ç†ç³»ç»Ÿ)
    â†“ HTTP/WebSocket
ä¸­é—´å±‚ç½‘å…³ (gateway.js, ç›‘å¬ 8080 ç«¯å£)
    â”œâ”€â”€ /api/*     â†’ API è·¯ç”±å¤„ç†
    â”œâ”€â”€ /admin     â†’ åå°ç®¡ç†é¡µé¢å’Œé™æ€èµ„æº
    â””â”€â”€ /ws        â†’ WebSocket å®æ—¶é€šä¿¡
```

### ğŸ”Œ ç«¯å£é…ç½®

- **ç½‘å…³ç›‘å¬ç«¯å£**: `8080` (ç›´æ¥è®¿é—®ï¼Œä¸ä½¿ç”¨ Nginx)
- **ç›‘å¬åœ°å€**: `0.0.0.0` (æ‰€æœ‰ç½‘ç»œæ¥å£)
- **åè®®**: HTTP (ç”Ÿäº§ç¯å¢ƒå»ºè®®é…ç½® HTTPS)

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

> **æ³¨æ„**: æ­¤ç½‘å…³æœåŠ¡éœ€è¦ä¸ä¸»é¡¹ç›®é…åˆä½¿ç”¨ã€‚è¯·ç¡®ä¿ä¸»é¡¹ç›®ä¸­çš„ `admin/` ç›®å½•å’Œ `data/` ç›®å½•ä¸æ­¤ç½‘å…³åœ¨åŒä¸€ç›®å½•ä¸‹ã€‚

### 1. ç¯å¢ƒè¦æ±‚

- Node.js >= 16.0.0
- npm >= 7.0.0

### 2. å®‰è£…ä¾èµ–

```bash
npm install
```

### 3. é…ç½®æœåŠ¡å™¨

ç¼–è¾‘ `config/server-mode.node.js`ï¼Œä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š

```javascript
// ä¿®æ”¹ä¸ºä½ çš„æœåŠ¡å™¨ IP å’Œç«¯å£
const BACKEND_CONFIG = {
  url: process.env.BACKEND_URL || 'http://192.168.31.189:8000',
  timeout: 30000,
  retries: 3
};
```

### 4. ç›®å½•ç»“æ„è¦æ±‚

ç¡®ä¿ä»¥ä¸‹ç›®å½•ç»“æ„å­˜åœ¨ï¼ˆä¸ä¸»é¡¹ç›®å…±äº«ï¼‰ï¼š

```
live-gateway/
â”œâ”€â”€ gateway.js                    # ç½‘å…³æœåŠ¡ä¸»æ–‡ä»¶
â”œâ”€â”€ config/
â”‚   â””â”€â”€ server-mode.node.js       # æœåŠ¡å™¨é…ç½®
â”œâ”€â”€ package.json
â””â”€â”€ (éœ€è¦ä¸ä¸»é¡¹ç›®å…±äº«)
    â”œâ”€â”€ admin/                    # åå°ç®¡ç†æ¨¡å—
    â”‚   â”œâ”€â”€ db.js                 # æ•°æ®åº“æ“ä½œ
    â”‚   â”œâ”€â”€ index.html            # ç®¡ç†é¡µé¢
    â”‚   â””â”€â”€ ...                   # å…¶ä»–ç®¡ç†æ–‡ä»¶
    â””â”€â”€ data/                     # æ•°æ®æ–‡ä»¶
        â”œâ”€â”€ streams.json          # ç›´æ’­æµæ•°æ®
        â”œâ”€â”€ users.json            # ç”¨æˆ·æ•°æ®
        â”œâ”€â”€ debate.json           # è¾©é¢˜æ•°æ®
        â””â”€â”€ ...                   # å…¶ä»–æ•°æ®æ–‡ä»¶
```

### 5. å¯åŠ¨ç½‘å…³æœåŠ¡

#### å¼€å‘æ¨¡å¼ï¼ˆè‡ªåŠ¨é‡å¯ï¼‰

```bash
npm run dev
```

#### ç”Ÿäº§æ¨¡å¼

```bash
npm start
```

### 6. éªŒè¯æœåŠ¡

è®¿é—®ä»¥ä¸‹åœ°å€éªŒè¯æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼š

- **API æµ‹è¯•**: http://localhost:8080/api/admin/dashboard
- **åå°ç®¡ç†**: http://localhost:8080/admin
- **å¥åº·æ£€æŸ¥**: http://localhost:8080/health
- **WebSocketæµ‹è¯•**: ws://localhost:8080/ws

---

## ğŸ”§ é…ç½®è¯´æ˜

### ä¸»è¦åŠŸèƒ½æ¨¡å—

#### 1. API è·¯ç”±å¤„ç† (`/api/*`)

- æ‰€æœ‰ API è¯·æ±‚ç”±ä¸­é—´å±‚ç›´æ¥å¤„ç†
- æ”¯æŒ CORS è·¨åŸŸè¯·æ±‚
- ç»Ÿä¸€é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- è¯·æ±‚å‹ç¼©å’Œå“åº”ä¼˜åŒ–

#### 2. åå°ç®¡ç†ç³»ç»Ÿ (`/admin`)

- æä¾›åå°ç®¡ç†é¡µé¢é™æ€æ–‡ä»¶æœåŠ¡
- æ”¯æŒ HTMLã€CSSã€JavaScript ç­‰é™æ€èµ„æº
- è‡ªåŠ¨è®¾ç½®é€‚å½“çš„ç¼“å­˜å¤´

#### 3. WebSocket å®æ—¶é€šä¿¡ (`/ws`)

- æ”¯æŒå®æ—¶æ•°æ®æ¨é€
- ç›´æ’­çŠ¶æ€æ›´æ–°
- æŠ•ç¥¨æ•°æ®åŒæ­¥
- AI å†…å®¹æ¨é€
- è¿æ¥å¿ƒè·³æ£€æµ‹

### é…ç½®æ–‡ä»¶è¯¦è§£

#### `gateway.js` - ä¸»ç½‘å…³æœåŠ¡æ–‡ä»¶
- Express åº”ç”¨é…ç½®
- ä¸­é—´ä»¶è®¾ç½®
- è·¯ç”±å®šä¹‰
- WebSocket æœåŠ¡å™¨

#### `config/server-mode.node.js` - æœåŠ¡å™¨é…ç½®
- ç«¯å£å’Œä¸»æœºè®¾ç½®
- åç«¯æœåŠ¡è¿æ¥é…ç½®
- CORS å’Œå®‰å…¨é…ç½®
- ç¼“å­˜å’Œæ—¥å¿—é…ç½®

---

## ğŸ“Š åŠŸèƒ½ç‰¹æ€§

### âœ… å·²å®ç°åŠŸèƒ½

- âœ… **API è·¯ç”±å¤„ç†** - å®Œæ•´çš„ REST API æ”¯æŒ
- âœ… **WebSocket å®æ—¶é€šä¿¡** - åŒå‘å®æ—¶æ•°æ®äº¤æ¢
- âœ… **CORS è·¨åŸŸæ”¯æŒ** - è§£å†³å‰ç«¯è·¨åŸŸé—®é¢˜
- âœ… **åå°ç®¡ç†ç³»ç»ŸæœåŠ¡** - é™æ€æ–‡ä»¶æ‰˜ç®¡
- âœ… **è¯·æ±‚å‹ç¼©** - Gzip å“åº”å‹ç¼©
- âœ… **å®‰å…¨å¤´é…ç½®** - Helmet å®‰å…¨ä¸­é—´ä»¶
- âœ… **æ—¥å¿—è®°å½•** - Morgan è¯·æ±‚æ—¥å¿—
- âœ… **å¥åº·æ£€æŸ¥** - æœåŠ¡çŠ¶æ€ç›‘æ§
- âœ… **é”™è¯¯å¤„ç†** - ç»Ÿä¸€çš„é”™è¯¯å“åº”
- âœ… **æ•°æ®æ–‡ä»¶æœåŠ¡** - JSON æ•°æ®æ–‡ä»¶è¯»å–

### ğŸš€ é«˜çº§ç‰¹æ€§

- **æ¨¡æ‹Ÿ API**: å†…ç½®å®Œæ•´çš„ Mock API å®ç°
- **å®æ—¶å¹¿æ’­**: WebSocket æ¶ˆæ¯å¹¿æ’­æœºåˆ¶
- **è¿æ¥ç®¡ç†**: WebSocket è¿æ¥çŠ¶æ€ç›‘æ§
- **æ€§èƒ½ä¼˜åŒ–**: å“åº”å‹ç¼©å’Œç¼“å­˜ç­–ç•¥
- **å¼€å‘å‹å¥½**: çƒ­é‡è½½å’Œè¯¦ç»†æ—¥å¿—

---

## ğŸ”Œ WebSocket æ¶ˆæ¯ç±»å‹

| æ¶ˆæ¯ç±»å‹ | æ–¹å‘ | æè¿° |
|----------|------|------|
| `connected` | æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ | è¿æ¥æˆåŠŸç¡®è®¤ |
| `liveStatus` | æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ | ç›´æ’­çŠ¶æ€æ›´æ–° |
| `votes-updated` | æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ | æŠ•ç¥¨æ•°æ®æ›´æ–° |
| `aiStatus` | æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ | AI è¯†åˆ«çŠ¶æ€ |
| `newAIContent` | æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ | æ–° AI å†…å®¹ |
| `debate-updated` | æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ | è¾©é¢˜æ›´æ–° |
| `ping` | å®¢æˆ·ç«¯â†’æœåŠ¡ç«¯ | å¿ƒè·³æ£€æµ‹ |
| `pong` | æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ | å¿ƒè·³å“åº” |
| `subscribe` | å®¢æˆ·ç«¯â†’æœåŠ¡ç«¯ | è®¢é˜…æ¶ˆæ¯ç±»å‹ |

### WebSocket ä½¿ç”¨ç¤ºä¾‹

```javascript
// å®¢æˆ·ç«¯è¿æ¥
const ws = new WebSocket('ws://localhost:8080/ws');

// ç›‘å¬æ¶ˆæ¯
ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log('æ”¶åˆ°æ¶ˆæ¯:', data);

  switch(data.type) {
    case 'connected':
      console.log('WebSocket è¿æ¥æˆåŠŸ');
      break;
    case 'liveStatus':
      console.log('ç›´æ’­çŠ¶æ€æ›´æ–°:', data.data);
      break;
    // å¤„ç†å…¶ä»–æ¶ˆæ¯ç±»å‹...
  }
};

// å‘é€å¿ƒè·³
setInterval(() => {
  ws.send(JSON.stringify({ type: 'ping' }));
}, 30000);
```

---

## ğŸ› å¸¸è§é—®é¢˜

### 1. ç«¯å£è¢«å ç”¨

**é”™è¯¯ä¿¡æ¯**:
```
Error: listen EADDRINUSE: address already in use :::8080
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -ano | findstr :8080

# åœæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹
taskkill /PID <PID> /F

# æˆ–ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„ç«¯å£å·
```

### 2. WebSocket è¿æ¥å¤±è´¥

**å¯èƒ½åŸå› **:
- é˜²ç«å¢™é˜»æ­¢ WebSocket è¿æ¥
- ç½‘ç»œè¿æ¥é—®é¢˜
- WebSocket è·¯å¾„é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
- ç¡®è®¤æœåŠ¡å™¨ IP åœ°å€æ­£ç¡®
- éªŒè¯ WebSocket è·¯å¾„ `/ws` æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ä¿¡æ¯

### 3. é™æ€æ–‡ä»¶æ— æ³•è®¿é—®

**é”™è¯¯ä¿¡æ¯**: 404 é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿ `admin/` ç›®å½•å­˜åœ¨ä¸”åŒ…å«æ­£ç¡®çš„æ–‡ä»¶
- æ£€æŸ¥ç›®å½•æƒé™
- éªŒè¯æ–‡ä»¶è·¯å¾„é…ç½®

### 4. API è¯·æ±‚å¤±è´¥

**å¯èƒ½åŸå› **:
- åç«¯æœåŠ¡æœªå¯åŠ¨
- ç½‘ç»œè¿æ¥é—®é¢˜
- API è·¯å¾„é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€
- éªŒè¯ API è·¯å¾„å’Œå‚æ•°
- æŸ¥çœ‹ç½‘å…³æ—¥å¿—è¾“å‡º

### 5. ä¾èµ–å®‰è£…å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ¸…é™¤ç¼“å­˜åé‡æ–°å®‰è£…
rm -rf node_modules package-lock.json
npm cache clean --force
npm install
```

---

## ğŸ”’ å®‰å…¨å»ºè®®

### ç”Ÿäº§ç¯å¢ƒé…ç½®

#### 1. HTTPS é…ç½®
```javascript
// ä½¿ç”¨ HTTPS
const https = require('https');
const fs = require('fs');

const options = {
  key: fs.readFileSync('path/to/private-key.pem'),
  cert: fs.readFileSync('path/to/certificate.pem')
};

https.createServer(options, app).listen(443);
```

#### 2. ç¯å¢ƒå˜é‡ç®¡ç†
```javascript
// ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨æ•æ„Ÿä¿¡æ¯
const BACKEND_URL = process.env.BACKEND_URL;
const API_KEY = process.env.API_KEY;
```

#### 3. è¯·æ±‚é¢‘ç‡é™åˆ¶
```javascript
const rateLimit = require('express-rate-limit');

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100 // limit each IP to 100 requests per windowMs
});

app.use('/api/', limiter);
```

#### 4. è¾“å…¥éªŒè¯
```javascript
const validator = require('validator');

// éªŒè¯ç”¨æˆ·è¾“å…¥
if (!validator.isEmail(email)) {
  return res.status(400).json({ error: 'æ— æ•ˆçš„é‚®ç®±åœ°å€' });
}
```

### ç›‘æ§å’Œæ—¥å¿—

#### æ—¥å¿—è½®è½¬
```javascript
const winston = require('winston');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({
      filename: 'logs/error.log',
      level: 'error'
    }),
    new winston.transports.File({
      filename: 'logs/combined.log'
    })
  ]
});
```

#### æ€§èƒ½ç›‘æ§
- æ·»åŠ å“åº”æ—¶é—´ç›‘æ§
- å†…å­˜ä½¿ç”¨ç›‘æ§
- é”™è¯¯ç‡ç»Ÿè®¡

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. å“åº”å‹ç¼©
```javascript
const compression = require('compression');
app.use(compression()); // è‡ªåŠ¨å‹ç¼©å“åº”
```

### 2. é™æ€æ–‡ä»¶ç¼“å­˜
```javascript
app.use('/admin', express.static('admin', {
  maxAge: '1d' // ç¼“å­˜1å¤©
}));
```

### 3. è¿æ¥æ± ç®¡ç†
```javascript
const pool = new Pool({
  max: 20,     // æœ€å¤§è¿æ¥æ•°
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});
```

### 4. è´Ÿè½½å‡è¡¡
```javascript
// ä½¿ç”¨å¤šä¸ªåç«¯æœåŠ¡å™¨
const backends = ['http://server1:8000', 'http://server2:8000'];
const current = 0;

app.use('/api', (req, res) => {
  const backend = backends[current % backends.length];
  // ä»£ç†è¯·æ±‚åˆ°åç«¯
});
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Express å®˜æ–¹æ–‡æ¡£](https://expressjs.com/)
- [WebSocket (ws) æ–‡æ¡£](https://github.com/websockets/ws)
- [CORS é…ç½®æŒ‡å—](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS)
- [Node.js æœ€ä½³å®è·µ](https://nodejs.org/en/docs/guides/)

---

## ğŸ“ ç‰ˆæœ¬å†å²

### v2.0.0 (2025-11-04)
- ğŸš€ ä» Nginx åå‘ä»£ç†è¿ç§»åˆ° Node.js ä¸­é—´å±‚
- ğŸ—‘ï¸ ç§»é™¤ Nginx ä¾èµ–ï¼Œç»Ÿä¸€ç½‘å…³é…ç½®
- âš¡ ä¼˜åŒ– WebSocket æ”¯æŒå’Œå®æ—¶é€šä¿¡
- ğŸ”§ æ·»åŠ è¯·æ±‚å‹ç¼©å’Œå®‰å…¨å¤´é…ç½®
- ğŸ“Š é›†æˆå®Œæ•´çš„ Mock API å®ç°
- ğŸ” æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•å’Œé”™è¯¯å¤„ç†

### v1.0.0 (2025-11-04)
- ğŸ¯ åˆå§‹ç‰ˆæœ¬ï¼ˆNginx é…ç½®ï¼‰
- âœ… æ”¯æŒ WebSocket ä»£ç†
- âœ… æ”¯æŒ API å’Œåå°ç®¡ç†ç³»ç»Ÿä»£ç†
- âœ… åŸºæœ¬çš„åå‘ä»£ç†åŠŸèƒ½

---

## ğŸ“„ è®¸å¯è¯

MIT License - è¯¦è§ LICENSE æ–‡ä»¶

---

## ğŸ‘¤ ä½œè€…

**ç›´æ’­è¾©è®ºç³»ç»Ÿå¼€å‘å›¢é˜Ÿ**

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. åˆ›å»º Pull Request

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
- ğŸ“§ Email: gateway@live-debate.com
- ğŸ› Issues: [GitHub Issues](https://github.com/your-repo/issues)

---

**â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™å®ƒä¸€ä¸ªæ˜Ÿæ ‡ï¼**

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†è¾¾æˆæƒ…å†µ

| éªŒæ”¶é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| **API è·¯ç”±å¤„ç†** | âœ… | å®Œæ•´å®ç°æ‰€æœ‰ /api/* è·¯ç”± |
| **WebSocket é€šä¿¡** | âœ… | æ”¯æŒå®æ—¶åŒå‘é€šä¿¡ |
| **åå°ç®¡ç†æœåŠ¡** | âœ… | é™æ€æ–‡ä»¶æ‰˜ç®¡åŠŸèƒ½ |
| **è·¨åŸŸæ”¯æŒ** | âœ… | CORS é…ç½®å®Œå–„ |
| **é”™è¯¯å¤„ç†** | âœ… | ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼ |
| **æ€§èƒ½ä¼˜åŒ–** | âœ… | å‹ç¼©å’Œç¼“å­˜é…ç½® |
| **æ–‡æ¡£å®Œæ•´** | âœ… | è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜ |
| **éƒ¨ç½²å°±ç»ª** | âœ… | æ”¯æŒå¤šç§éƒ¨ç½²æ–¹å¼ |

**ğŸ‰ ç½‘å…³æœåŠ¡å®ç°å®Œæˆï¼Œå·²å‡†å¤‡å¥½æ›¿ä»£ Nginx åå‘ä»£ç†ï¼**
